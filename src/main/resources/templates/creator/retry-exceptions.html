<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header('Исключения ограничений')}">
<body>
<div th:replace="~{fragments/navigation}"></div>
<div class="container-fluid py-3 py-md-4" style="background-color: #f8f9fa;">
    <div class="container px-2 px-md-3">
        <div class="mb-3 mb-md-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb flex-wrap">
                    <li class="breadcrumb-item"><a th:href="@{/creator/tests}" class="text-decoration-none">Мои тесты</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/creator/tests/{testId}/statistics(testId=${test.id})}"
                                                   class="text-decoration-none">Статистика</a></li>
                    <li class="breadcrumb-item active">Исключения</li>
                </ol>
            </nav>
            <h1 class="h3 h2-md mb-0" th:text="'Исключения для теста: ' + ${test.title}">
                Исключения для теста
            </h1>
        </div>
        <!-- Форма создания исключения -->
        <div class="card border-0 shadow-sm mb-3 mb-md-4">
            <div class="card-header bg-white py-2">
                <h5 class="mb-0 h6 h5-md">Создать исключение</h5>
            </div>
            <div class="card-body p-3 p-md-4">
                <form th:action="@{/creator/tests/{testId}/exceptions/create(testId=${test.id})}" method="post" class="row g-2 g-md-3">
                    <div class="col-12 col-md-3">
                        <label class="form-label small fw-semibold">Тестировщик</label>
                        <select class="form-select form-select-sm" name="testerUsername" required>
                            <option value="">Выберите...</option>
                            <option th:each="tester : ${testers}"
                                    th:value="${tester.username}"
                                    th:text="${tester.fullName} + ' (' + ${tester.username} + ')'">
                                Иванов И.И. (ivanov)
                            </option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold">Часов</label>
                        <input type="number" class="form-control form-control-sm" name="hours" min="1" placeholder="Часы">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold">Причина</label>
                        <input type="text" class="form-control form-control-sm" name="reason" placeholder="Причина">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold">Постоянное</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="permanent" id="permanent" value="true">
                            <label class="form-check-label small" for="permanent">
                                Бессрочно
                            </label>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-dark w-100 btn-sm">
                            <i class="bi bi-plus-circle me-2"></i>Создать
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Список тестировщиков -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-2">
                <h5 class="mb-0 h6 h5-md">Тестировщики, проходившие тест</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Тестировщик</th>
                            <th class="d-none d-sm-table-cell">Статус</th>
                            <th class="d-none d-md-table-cell">Следующая попытка</th>
                            <th class="text-end">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="tester : ${testers}">
                            <td>
                                <span class="fw-semibold" th:text="${tester.fullName} ?: tester.username">Иванов И.И.</span>
                                <br>
                                <small class="text-muted d-block d-sm-none" th:text="'@' + ${tester.username}">@username</small>
                                <!-- Статус для мобильных -->
                                <span class="d-block d-sm-none mt-1" th:id="'status-mobile-' + ${tester.username}">
                                    <span class="badge bg-secondary">Загрузка...</span>
                                </span>
                            </td>
                            <td class="d-none d-sm-table-cell" th:id="'status-' + ${tester.username}">
                                <span class="badge bg-secondary">Загрузка...</span>
                            </td>
                            <td class="d-none d-md-table-cell" th:id="'next-' + ${tester.username}">-</td>
                            <td class="text-end">
                                <button type="button" class="btn btn-sm btn-outline-warning"
                                        onclick="removeException('${tester.username}')"
                                        title="Снять ограничения">
                                    <i class="bi bi-clock-history"></i>
                                    <span class="d-none d-sm-inline ms-1">Снять</span>
                                </button>
                            </td>
                            <form th:id="'removeForm' + ${tester.username}"
                                  th:action="@{/creator/tests/{testId}/exceptions/remove/{username}(testId=${test.id}, username=${tester.username})}"
                                  method="post" style="display: none;"></form>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script th:inline="javascript">
    function loadCooldownStatus(username) {
        $.get(`/creator/tests/${testId}/exceptions/status/` + username, function(data) {
            if (data.success) {
                // Для десктопа
                const statusSpan = $('#status-' + username + ' span');
                const nextTd = $('#next-' + username);

                // Для мобильных
                const mobileStatusSpan = $('#status-mobile-' + username + ' span');

                if (data.status === 'Ограничение' || (data.hasCooldown && data.nextAvailable)) {
                    const statusText = 'Ограничение';
                    const badgeClass = 'bg-warning';
                    const nextText = data.nextAvailable ? new Date(data.nextAvailable).toLocaleString() : '-';

                    statusSpan.removeClass().addClass('badge ' + badgeClass).text(statusText);
                    if (mobileStatusSpan.length) {
                        mobileStatusSpan.removeClass().addClass('badge ' + badgeClass).text(statusText);
                    }
                    nextTd.text(nextText);
                } else if (data.status === 'Исключение') {
                    statusSpan.removeClass().addClass('badge bg-info').text('Исключение');
                    if (mobileStatusSpan.length) {
                        mobileStatusSpan.removeClass().addClass('badge bg-info').text('Исключение');
                    }
                    nextTd.text('-');
                } else {
                    statusSpan.removeClass().addClass('badge bg-success').text('Доступно');
                    if (mobileStatusSpan.length) {
                        mobileStatusSpan.removeClass().addClass('badge bg-success').text('Доступно');
                    }
                    nextTd.text('-');
                }
            } else {
                $('#status-' + username + ' span').removeClass().addClass('badge bg-danger').text('Ошибка');
                $('#status-mobile-' + username + ' span').removeClass().addClass('badge bg-danger').text('Ошибка');
            }
        }).fail(function() {
            $('#status-' + username + ' span').removeClass().addClass('badge bg-danger').text('Ошибка');
            $('#status-mobile-' + username + ' span').removeClass().addClass('badge bg-danger').text('Ошибка');
        });
    }

    function removeException(username) {
        if (confirm('Снять ограничения для пользователя ' + username + '?')) {
            document.getElementById('removeForm' + username).submit();
        }
    }

    /*<![CDATA[*/
    const testId = /*[[${test.id}]]*/ null;
    const testerUsernames = /*[[${testers.![username]}]]*/ [];

    $(document).ready(function() {
        testerUsernames.forEach(function(username) {
            if (username) {
                loadCooldownStatus(username);
            }
        });

        setInterval(function() {
            testerUsernames.forEach(function(username) {
                if (username) {
                    loadCooldownStatus(username);
                }
            });
        }, 30000);
    });
    /*]]>*/
</script>
</body>
</html>