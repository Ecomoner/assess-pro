<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header('–ú–æ–∏ —Ç–µ—Å—Ç—ã')}">
<body>
<div th:replace="~{fragments/navigation}"></div>

<div class="container-fluid py-3 py-md-4" style="background-color: #f8f9fa;">
    <div class="container px-2 px-md-3">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-md-4 gap-2">
            <h1 class="h3 h2-md mb-0">
                <i class="bi bi-file-text text-success me-2"></i>
                –ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Å—Ç–æ–≤  <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: "–ú–æ–∏ —Ç–µ—Å—Ç—ã" ‚Üí "–ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Å—Ç–æ–≤" -->
            </h1>
            <a th:href="@{/creator/tests/new}" class="btn btn-dark w-100 w-sm-auto">
                <i class="bi bi-plus-circle me-2"></i>–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç
            </a>
        </div>

        <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
        <div class="row g-2 g-md-3 mb-3 mb-md-4">
            <!-- ... –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å ... -->
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã (–î–û–ë–ê–í–õ–ï–ù –§–ò–õ–¨–¢–† –ü–û –°–û–ó–î–ê–¢–ï–õ–Æ) -->
        <div class="card border-0 shadow-sm mb-3 mb-md-4">
            <div class="card-body p-3 p-md-4">
                <form th:action="@{/creator/tests}" method="get" class="row g-2 g-md-3">
                    <div class="col-12 col-md-2">
                        <label class="form-label small fw-semibold d-block d-md-none">–ü–æ–∏—Å–∫</label>
                        <input type="text" class="form-control form-control-sm" name="search" th:value="${search}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
                    </div>

                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold d-block d-md-none">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select form-select-sm" name="status">
                            <option value="">–í—Å–µ</option>
                            <option value="published" th:selected="${status == 'published'}">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ</option>
                            <option value="draft" th:selected="${status == 'draft'}">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</option>
                        </select>
                    </div>

                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold d-block d-md-none">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select form-select-sm" name="categoryId">
                            <option value="">–í—Å–µ</option>
                            <option th:each="cat : ${filterCategories}"
                                    th:value="${cat.id}"
                                    th:text="${cat.name}"
                                    th:selected="${categoryId == cat.id}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                        </select>
                    </div>

                    <!-- üî• –ù–û–í–´–ô –§–ò–õ–¨–¢–†: –ø–æ —Å–æ–∑–¥–∞—Ç–µ–ª—é -->
                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold d-block d-md-none">–°–æ–∑–¥–∞—Ç–µ–ª—å</label>
                        <select class="form-select form-select-sm" name="creatorId">
                            <option value="">–í—Å–µ —Å–æ–∑–¥–∞—Ç–µ–ª–∏</option>
                            <option th:each="creator : ${creators}"
                                    th:value="${creator.id}"
                                    th:text="${creator.fullName}"
                                    th:selected="${selectedCreatorId == creator.id}">–°–æ–∑–¥–∞—Ç–µ–ª—å</option>
                        </select>
                    </div>

                    <div class="col-6 col-md-2">
                        <label class="form-label small fw-semibold d-block d-md-none">–†–∞–∑–º–µ—Ä</label>
                        <select class="form-select form-select-sm" name="size">
                            <option value="10" th:selected="${pageSize == 10}">10</option>
                            <option value="20" th:selected="${pageSize == 20}">20</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                        </select>
                    </div>

                    <div class="col-6 col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-dark w-100 btn-sm">
                            <i class="bi bi-filter me-1"></i>–ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show py-2">...</div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show py-2">...</div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–µ—Å—Ç–æ–≤ -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th class="d-none d-sm-table-cell">ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <!-- üî• –ù–û–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–æ–∑–¥–∞—Ç–µ–ª—å -->
                            <th class="d-none d-md-table-cell">–°–æ–∑–¥–∞—Ç–µ–ª—å</th>
                            <th class="d-none d-md-table-cell">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="d-none d-lg-table-cell">–í–æ–ø—Ä–æ—Å–æ–≤</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th class="d-none d-sm-table-cell">–¢–∞–π–º–µ—Ä</th>
                            <th class="d-none d-md-table-cell">–°–æ–∑–¥–∞–Ω</th>
                            <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="test : ${tests}"
                            th:classappend="${ownershipMap[test.id] ? '' : 'table-secondary'}">  <!-- üî• –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —á—É–∂–∏—Ö —Ç–µ—Å—Ç–æ–≤ -->
                            <td class="d-none d-sm-table-cell" th:text="${test.id}">1</td>
                            <td>
                                <strong class="small" th:text="${test.title}">–¢–µ—Å—Ç</strong>
                                <br>
                                <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ -->
                                <small class="text-muted d-block d-md-none">
                                    <span th:text="${test.creatorUsername}">creator</span>
                                    <span th:if="${test.categoryName != null}">
                                                <span th:text="' ¬∑ ' + ${test.categoryName}"></span>
                                            </span>
                                </small>
                            </td>
                            <!-- üî• –ù–û–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–æ–∑–¥–∞—Ç–µ–ª—å (–¥–µ—Å–∫—Ç–æ–ø) -->
                            <td class="d-none d-md-table-cell">
                                <span class="small" th:text="${test.creatorUsername}">user</span>
                                <span th:if="${test.creatorUsername == #authentication.name}"
                                      class="badge bg-success ms-1 small">–º–æ–π</span>
                            </td>
                            <td class="d-none d-md-table-cell">
                                <span th:if="${test.categoryName != null}" class="badge bg-light text-dark border small" th:text="${test.categoryName}">–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</span>
                                <span th:if="${test.categoryName == null}" class="text-muted small">-</span>
                            </td>
                            <td class="d-none d-lg-table-cell" th:text="${test.questionCount}">10</td>
                            <td>
                                <span class="badge" style="font-size: 0.7rem;" th:classappend="${test.published} ? 'bg-success' : 'bg-secondary'"
                                      th:text="${test.published} ? '–û–ø—É–±–ª.' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'">–û–ø—É–±–ª.</span>
                            </td>
                            <td class="d-none d-sm-table-cell">
                                <span th:if="${test.timeLimitMinutes > 0}" class="small" th:text="${test.timeLimitMinutes} + ' –º–∏–Ω'">30 –º–∏–Ω</span>
                                <span th:if="${test.timeLimitMinutes == 0}" class="text-muted small">-</span>
                            </td>
                            <td class="d-none d-md-table-cell small" th:text="${#temporals.format(test.createdAt, 'dd.MM.yy')}">01.01.24</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: –í–æ–ø—Ä–æ—Å—ã - –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤ -->
                                    <a th:if="${ownershipMap[test.id]}"
                                       th:href="@{/creator/tests/{id}/questions(id=${test.id})}"
                                       class="btn btn-outline-dark"
                                       title="–í–æ–ø—Ä–æ—Å—ã">
                                        <i class="bi bi-question-circle"></i>
                                    </a>
                                    <span th:unless="${ownershipMap[test.id]}"
                                          class="btn btn-outline-dark opacity-50"
                                          style="cursor: not-allowed;"
                                          title="–í–æ–ø—Ä–æ—Å—ã (–¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É)">
                                        <i class="bi bi-question-circle"></i>
                                    </span>

                                    <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤ -->
                                    <a th:if="${ownershipMap[test.id]}"
                                       th:href="@{/creator/tests/edit/{id}(id=${test.id})}"
                                       class="btn btn-outline-primary"
                                       title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <span th:unless="${ownershipMap[test.id]}"
                                          class="btn btn-outline-primary opacity-50"
                                          style="cursor: not-allowed;"
                                          title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É)">
                                        <i class="bi bi-pencil"></i>
                                    </span>

                                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä - –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
                                    <a th:href="@{/creator/tests/{id}/preview(id=${test.id})}"
                                       class="btn btn-outline-info"
                                       title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                                        <i class="bi bi-eye"></i>
                                    </a>

                                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
                                    <a th:href="@{/creator/tests/{testId}/statistics/testers(testId=${test.id})}"
                                       class="btn btn-outline-success"
                                       title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">
                                        <i class="bi bi-bar-chart"></i>
                                    </a>

                                    <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: –ü—É–±–ª–∏–∫–∞—Ü–∏—è - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤ -->
                                    <button th:if="${ownershipMap[test.id]}"
                                            type="button"
                                            class="btn btn-outline-warning publish-test-btn"
                                            th:data-id="${test.id}"
                                            th:data-publish="${!test.published}"
                                            th:data-title="${test.title}"
                                            th:title="${test.published} ? '–°–Ω—è—Ç—å —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å'">
                                        <i th:class="${test.published} ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                                    </button>
                                    <span th:unless="${ownershipMap[test.id]}"
                                          class="btn btn-outline-warning opacity-50"
                                          style="cursor: not-allowed;"
                                          title="–ü—É–±–ª–∏–∫–∞—Ü–∏—è (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É)">
                                        <i th:class="${test.published} ? 'bi bi-eye-slash' : 'bi bi-eye'"></i>
                                    </span>

                                    <!-- üî• –ò–ó–ú–ï–ù–ï–ù–û: –£–¥–∞–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤ -->
                                    <button th:if="${ownershipMap[test.id]}"
                                            type="button"
                                            class="btn btn-outline-danger delete-test-btn"
                                            th:data-id="${test.id}"
                                            th:data-title="${test.title}"
                                            title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <span th:unless="${ownershipMap[test.id]}"
                                          class="btn btn-outline-danger opacity-50"
                                          style="cursor: not-allowed;"
                                          title="–£–¥–∞–ª–∏—Ç—å (–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É)">
                                        <i class="bi bi-trash"></i>
                                    </span>
                                </div>

                                <!-- –°–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
                                <form th:id="'publishForm' + ${test.id}" th:action="@{/creator/tests/publish/{id}(id=${test.id})}"
                                      method="post" style="display: none;">
                                    <input type="hidden" name="publish" th:value="${!test.published}">
                                </form>
                                <form th:id="'deleteForm' + ${test.id}" th:action="@{/creator/tests/delete/{id}(id=${test.id})}"
                                      method="post" style="display: none;"></form>
                            </td>
                        </tr>

                        <tr th:if="${tests.isEmpty()}">
                            <td colspan="9" class="text-center py-4 text-muted">  <!-- —É–≤–µ–ª–∏—á–∏–ª colspan –Ω–∞ 1 -->
                                <i class="bi bi-info-circle fs-4 d-block mb-2"></i>
                                –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. <a th:href="@{/creator/tests/new}" class="text-success">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
            <div class="card-footer bg-white border-0 py-3">
                <div th:replace="~{fragments/pagination :: pagination(
        currentPage=${currentPage},
        totalPages=${totalPages},
        pageSize=${pageSize},
        baseUrl=@{/creator/tests(status=${status}, search=${search}, categoryId=${categoryId}, creatorId=${creatorId})}
    )}"></div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->
<div class="modal fade" id="deleteModal" tabindex="-1">...</div>
<div class="modal fade" id="publishModal" tabindex="-1">...</div>

<div th:replace="~{fragments/footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // JavaScript (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const publishModal = new bootstrap.Modal(document.getElementById('publishModal'));

        let currentDeleteId = null;
        let currentPublishId = null;
        let currentPublishState = null;

        document.querySelectorAll('.delete-test-btn').forEach(button => {
            button.addEventListener('click', function() {
                currentDeleteId = this.dataset.id;
                const title = this.dataset.title;
                document.getElementById('deleteTestTitle').textContent = title;
                deleteModal.show();
            });
        });

        document.querySelectorAll('.publish-test-btn').forEach(button => {
            button.addEventListener('click', function() {
                currentPublishId = this.dataset.id;
                currentPublishState = this.dataset.publish === 'true';
                const title = this.dataset.title;

                const message = currentPublishState ?
                    `–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ç–µ—Å—Ç "${title}"?` :
                    `–°–Ω—è—Ç—å —Ç–µ—Å—Ç "${title}" —Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏?`;

                document.getElementById('publishMessage').textContent = message;
                publishModal.show();
            });
        });

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (currentDeleteId) {
                document.getElementById('deleteForm' + currentDeleteId).submit();
            }
        });

        document.getElementById('confirmPublishBtn').addEventListener('click', function() {
            if (currentPublishId) {
                document.getElementById('publishForm' + currentPublishId).submit();
            }
        });
    });
</script>
</body>
</html>