<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header('Прохождение теста')}">
<body>
<div th:replace="~{fragments/navigation}"></div>

<div class="container-fluid py-3 py-md-4" style="background-color: #f8f9fa;">
    <div class="container px-2 px-md-3">
        <!-- Шапка теста -->
        <div class="card border-0 shadow-sm mb-3 mb-md-4">
            <div class="card-body p-3">
                <div class="row align-items-center g-2">
                    <div class="col-12 col-md-4">
                        <h2 class="h5 h4-md mb-1" th:text="${testTakingDTO.testTitle}">Название теста</h2>
                        <p class="text-muted small mb-0">
                            <i class="bi bi-question-circle me-1"></i>Вопрос <span th:text="${testTakingDTO.currentQuestionIndex + 1}">1</span>/<span th:text="${testTakingDTO.totalQuestions}">10</span>
                        </p>
                    </div>

                    <div class="col-8 col-md-4">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-dark" role="progressbar"
                                 th:style="'width: ' + (${testTakingDTO.currentQuestionIndex + 1}) * 100 / ${testTakingDTO.totalQuestions} + '%'"
                                 th:attr="aria-valuenow=${(testTakingDTO.currentQuestionIndex + 1) * 100 / testTakingDTO.totalQuestions}"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>

                    <div class="col-4 col-md-4 text-end">
                        <div th:if="${testTakingDTO.timeLimitMinutes > 0}"
                             id="timer"
                             class="h6 h5-md mb-0"
                             data-minutes="${testTakingDTO.timeLimitMinutes}">
                            <i class="bi bi-clock me-1"></i>
                            <span id="timerDisplay">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Текущий вопрос -->
        <div class="card border-0 shadow-sm mb-3 mb-md-4">
            <div class="card-body p-3 p-md-4">
                <div class="mb-3">
                    <h3 class="h6 fw-bold mb-2">Вопрос <span th:text="${testTakingDTO.currentQuestionIndex + 1}">1</span>:</h3>
                    <p class="small" th:text="${testTakingDTO.questions[testTakingDTO.currentQuestionIndex].text}">Текст вопроса</p>
                </div>

                <div class="answers-section">
                    <h4 class="h6 fw-bold mb-2">Выберите ответ:</h4>

                    <form id="answerForm" th:data-attempt-id="${testTakingDTO.attemptId}">
                        <div th:each="answer, iterStat : ${testTakingDTO.questions[testTakingDTO.currentQuestionIndex].answerOptions}" class="mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio"
                                       th:name="'question_' + ${testTakingDTO.questions[testTakingDTO.currentQuestionIndex].id}"
                                       th:id="'answer_' + ${answer.id}"
                                       th:value="${answer.id}">
                                <label class="form-check-label small" th:for="'answer_' + ${answer.id}" th:text="${answer.text}">
                                    Вариант ответа
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
                <div class="row align-items-center">
                    <div class="col-4">
                        <button type="button" class="btn btn-outline-secondary btn-sm w-100"
                                th:if="${testTakingDTO.currentQuestionIndex > 0}"
                                th:onclick="|goToQuestion(${testTakingDTO.currentQuestionIndex - 1})|">
                            <i class="bi bi-chevron-left"></i>
                            <span class="d-none d-sm-inline ms-1">Пред.</span>
                        </button>
                    </div>

                    <div class="col-4 text-center">
                        <span class="text-muted small">
                            <i class="bi bi-save me-1"></i>
                            <span id="saveStatus" class="d-none d-sm-inline">Автосохранение...</span>
                        </span>
                    </div>

                    <div class="col-4 text-end">
                        <button type="button" class="btn btn-outline-dark btn-sm w-100"
                                th:if="${testTakingDTO.currentQuestionIndex < testTakingDTO.totalQuestions - 1}"
                                th:onclick="|goToQuestion(${testTakingDTO.currentQuestionIndex + 1})|">
                            <span class="d-none d-sm-inline me-1">След.</span>
                            <i class="bi bi-chevron-right"></i>
                        </button>

                        <button type="button" class="btn btn-dark btn-sm w-100"
                                th:if="${testTakingDTO.currentQuestionIndex == testTakingDTO.totalQuestions - 1}"
                                data-bs-toggle="modal" data-bs-target="#finishModal">
                            <i class="bi bi-check-circle me-1"></i>
                            <span class="d-none d-sm-inline">Завершить</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно завершения -->
<div class="modal fade" id="finishModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white py-2">
                <h5 class="modal-title small">Завершение теста</h5>
                <button type="button" class="btn-close btn-close-white btn-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <p class="small mb-2">Завершить тест?</p>
                <p class="text-muted small mb-0">Неотвеченные вопросы будут считаться неправильными.</p>
            </div>
            <div class="modal-footer p-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Продолжить</button>
                <form th:action="@{/tester/attempt/{attemptId}/finish(attemptId=${testTakingDTO.attemptId})}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-dark">Завершить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/test-taking.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const attemptId = /*[[${testTakingDTO.attemptId}]]*/ null;
    const totalQuestions = /*[[${testTakingDTO.totalQuestions}]]*/ 0;
    const currentQuestionId = /*[[${testTakingDTO.questions[testTakingDTO.currentQuestionIndex].id}]]*/ null;
    const timeLimit = /*[[${testTakingDTO.timeLimitMinutes}]]*/ 0;

    if (timeLimit > 0) {
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            const minutes = timeLimit;
            startTimer(minutes, 0, attemptId);
        }
    }
    /*]]>*/

    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            saveAnswer(attemptId, currentQuestionId, this.value);
        });
    });

    function saveAnswer(attemptId, questionId, answerId) {
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Сохранение...';

        fetch(`/tester/attempt/${attemptId}/answer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                attemptId: attemptId,
                questionId: questionId,
                answerOptionId: answerId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    saveStatus.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>Сохранено';

                    // Если тест завершен, перенаправляем на страницу результатов
                    if (data.completed) {
                        window.location.href = `/tester/attempt/${attemptId}/results`;
                    } else {
                        setTimeout(() => {
                            saveStatus.innerHTML = '<i class="bi bi-save me-1"></i>Автосохранение...';
                        }, 2000);
                    }
                } else {
                    saveStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-danger me-1"></i>Ошибка';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                saveStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-danger me-1"></i>Ошибка';
            });
    }


    function goToQuestion(index) {
        window.location.href = `/tester/attempt/${attemptId}/question/${index}`;
    }

    function startTimer(minutes, seconds, attemptId) {
        let totalSeconds = minutes * 60 + seconds;
        const timerDisplay = document.getElementById('timerDisplay');

        const timer = setInterval(() => {
            if (totalSeconds <= 0) {
                clearInterval(timer);
                document.querySelector(`form[action="/tester/attempt/${attemptId}/finish"]`).submit();
                return;
            }

            totalSeconds--;

            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            if (totalSeconds === 300) {
                alert('Осталось 5 минут!');
            }
        }, 1000);
    }
</script>
</body>
</html>